{"ast":null,"code":"'use strict';\n\nvar tls = require('tls');\n\nfunction buildBuilder(mqttClient, opts) {\n  var connection;\n  opts.port = opts.port || 8883;\n  opts.host = opts.hostname || opts.host || 'localhost';\n  opts.rejectUnauthorized = opts.rejectUnauthorized !== false;\n  delete opts.path;\n  connection = tls.connect(opts);\n  /* eslint no-use-before-define: [2, \"nofunc\"] */\n\n  connection.on('secureConnect', function () {\n    if (opts.rejectUnauthorized && !connection.authorized) {\n      connection.emit('error', new Error('TLS not authorized'));\n    } else {\n      connection.removeListener('error', handleTLSerrors);\n    }\n  });\n\n  function handleTLSerrors(err) {\n    // How can I get verify this error is a tls error?\n    if (opts.rejectUnauthorized) {\n      mqttClient.emit('error', err);\n    } // close this connection to match the behaviour of net\n    // otherwise all we get is an error from the connection\n    // and close event doesn't fire. This is a work around\n    // to enable the reconnect code to work the same as with\n    // net.createConnection\n\n\n    connection.end();\n  }\n\n  connection.on('error', handleTLSerrors);\n  return connection;\n}\n\nmodule.exports = buildBuilder;","map":null,"metadata":{},"sourceType":"script"}