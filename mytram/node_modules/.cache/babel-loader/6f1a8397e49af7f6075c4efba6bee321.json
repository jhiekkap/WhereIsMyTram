{"ast":null,"code":"'use strict';\n/* global wx */\n\nvar socketOpen = false;\nvar socketMsgQueue = [];\n\nfunction sendSocketMessage(msg) {\n  if (socketOpen) {\n    wx.sendSocketMessage({\n      data: msg.buffer || msg\n    });\n  } else {\n    socketMsgQueue.push(msg);\n  }\n}\n\nfunction WebSocket(url, protocols) {\n  var ws = {\n    OPEN: 1,\n    CLOSING: 2,\n    CLOSED: 3,\n    readyState: socketOpen ? 1 : 0,\n    send: sendSocketMessage,\n    close: wx.closeSocket,\n    onopen: null,\n    onmessage: null,\n    onclose: null,\n    onerror: null\n  };\n  wx.connectSocket({\n    url: url,\n    protocols: protocols\n  });\n  wx.onSocketOpen(function (res) {\n    ws.readyState = ws.OPEN;\n    socketOpen = true;\n\n    for (var i = 0; i < socketMsgQueue.length; i++) {\n      sendSocketMessage(socketMsgQueue[i]);\n    }\n\n    socketMsgQueue = [];\n    ws.onopen && ws.onopen.apply(ws, arguments);\n  });\n  wx.onSocketMessage(function (res) {\n    ws.onmessage && ws.onmessage.apply(ws, arguments);\n  });\n  wx.onSocketClose(function () {\n    ws.onclose && ws.onclose.apply(ws, arguments);\n    ws.readyState = ws.CLOSED;\n    socketOpen = false;\n  });\n  wx.onSocketError(function () {\n    ws.onerror && ws.onerror.apply(ws, arguments);\n    ws.readyState = ws.CLOSED;\n    socketOpen = false;\n  });\n  return ws;\n}\n\nvar websocket = require('websocket-stream');\n\nfunction buildUrl(opts, client) {\n  var protocol = opts.protocol === 'wxs' ? 'wss' : 'ws';\n  var url = protocol + '://' + opts.hostname + opts.path;\n\n  if (opts.port && opts.port !== 80 && opts.port !== 443) {\n    url = protocol + '://' + opts.hostname + ':' + opts.port + opts.path;\n  }\n\n  if (typeof opts.transformWsUrl === 'function') {\n    url = opts.transformWsUrl(url, opts, client);\n  }\n\n  return url;\n}\n\nfunction setDefaultOpts(opts) {\n  if (!opts.hostname) {\n    opts.hostname = 'localhost';\n  }\n\n  if (!opts.path) {\n    opts.path = '/';\n  }\n\n  if (!opts.wsOptions) {\n    opts.wsOptions = {};\n  }\n}\n\nfunction createWebSocket(client, opts) {\n  var websocketSubProtocol = opts.protocolId === 'MQIsdp' && opts.protocolVersion === 3 ? 'mqttv3.1' : 'mqtt';\n  setDefaultOpts(opts);\n  var url = buildUrl(opts, client);\n  return websocket(WebSocket(url, [websocketSubProtocol]));\n}\n\nfunction buildBuilder(client, opts) {\n  opts.hostname = opts.hostname || opts.host;\n\n  if (!opts.hostname) {\n    throw new Error('Could not determine host. Specify host manually.');\n  }\n\n  return createWebSocket(client, opts);\n}\n\nmodule.exports = buildBuilder;","map":null,"metadata":{},"sourceType":"script"}